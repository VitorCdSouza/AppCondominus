f"}[t.handleResult]),h[o](t,i,n)):void e.consoleLog("failed to find handler for: "+o)}return!0}}async initialisePopup(s,i){let a={hostedURL:await t.getPopupCDNUrl()};if(this.tabs[s.id]){a=e.extend(a,this.tabs[s.id]);const t=`chrome-extension://${chrome.runtime.id}`;s.url.startsWith(t)&&(a.is_viewer=!0);["chrome://extensions/",t,"chrome://newtab/","https://chrome.google.com","https://acrobat.adobe.com/link/file/?uri=","https://acrobat.adobe.com/id/urn:","https://acrobat.adobe.com/link/review/?uri="].some((e=>s.url.startsWith(e)))&&(a.isBlacklistedUrl=!0);if(!["downloading","pdf_downloading","waiting","in_progress","complete"].includes(a.current_status)||a.isBlacklistedUrl){const e=a.is_pdf;this.clearStatus(a),a.is_pdf=e}e.isLocalFileUrl(s.url)&&(a.is_pdf=!0,a.isFillnSignEnabled=l.FILL_N_SIGN_ENABLED),a.isAcrobat=e.isAcrobatAvailable(this.version),a.autoOpenPDFInAcrobat="false"!==d.getItem("ViewResultsPref")}i(a)}echoRequest(t){var i,a,n;if(!(l.CHROME_VERSION<l.SUPPORTED_VERSION)){if(!this.avoidUrl(t.url)){var r=t.id||t.tabId;return this.tabs[r]&&("cancelled"!==(i=this.tabs[r]).current_status&&"pdf_opened"!==i.current_status&&"pdf_failure"!==i.current_status&&"viewer_menu"!==i.panel_op||(n=i.is_pdf,this.clearStatus(i),i.is_pdf=n),i.current_status&&(i.panel_op="status"),this,a=i.is_pdf?"pdf_menu":"html_menu",i.panel_op&&"load-frictionless"===i.panel_op&&(delete i.panel_op,s.event(s.e.FRICTIONLESS_WIDGET_CLOSED)),"resize_window"===i.content_op&&(delete i.content_op,delete i.window_height),i.panel_op=i.panel_op||a,"html_menu"===a&&(i.persist=!1),i.incognito=t.incognito,e.isLocalFileUrl(t.url)&&(i.panel_op="pdf_menu",i.is_pdf=!0,i.isFillnSignEnabled=l.FILL_N_SIGN_ENABLED),t.url.startsWith(`chrome-extension://${chrome.runtime.id}`)?(i.panel_op="viewer_menu",i.is_viewer=!0):i.is_viewer=!1,e.consoleLog("repeat cached request: "+i.panel_op)),i}this.disable(t.id)}}async echo(t){const i=d.getItem("appLocale");if(s.event(s.e.TREFOIL_CLICKED),l.CHROME_VERSION<l.SUPPORTED_VERSION){this.getModule("session").newSession("browser/js/options.html",!0,{})}else{var a=this.echoRequest(t);if(a){"search"===a.frictionless_workflow&&(a.suppress_frictionless=!0),a.trefoilClick=!0,a.frictionless_workflow=null,a.frame_visibility=null,a.persist=await this.isEnablePersistMenu(a);let t=chrome.i18n.getMessage("@@ui_locale");a.locale=i||e.getFrictionlessLocale(t),this.sendMessage(a)}}}setGlobals(e){this.globals=e}dump(t,s){var i,a=[s];for(i in t)t.hasOwnProperty(i)&&a.push("  "+i+": "+t[i]);e.consoleLog(a.join("\n"))}sendMessage(t,i=!0,a){var n,r=t.tabId;this.dump(t,"Sending message:"),t.version=this.version,e.consoleLog("sendMessage version",t),i&&(this.tabs[r]=e.extend(this.tabs[r],t)),t.NMHConnStatus=this.NMHConnStatus,e.showFrictionlessMenu(t)&&(t.show_frictionless=!0),t.is_edge=e.isEdge(),"pdf_menu"===t.panel_op&&(t.trefoilClick?n=s.e.TREFOIL_PDF_FROM_CLICK:0==t.persist&&0!=t.version&&(n=s.e.TREFOIL_PDF_MENU_SHOWN)),"flickr"===t.panel_op&&(n=s.e.FLICKR_OFFER_SHOWN),"html_menu"===t.panel_op&&(n=s.e.TREFOIL_HTML_FROM_CLICK),n&&s.checkAndLogAnalytics(n),e.sendMessage(t,this.globals,a),delete t.trefoilClick,delete t.mimeHandled,delete this.tabs[r].trefoilClick,delete this.tabs[r].mimeHandled}deferMessage(e){"undefined"==typeof setTimeout?this.sendMessage(e):setTimeout(this.proxy(this.sendMessage,e),0)}sendMessageToPopup(t,s=!0){const i=t.tabId;t.version=this.version,s&&(this.tabs[i]=e.extend(this.tabs[i],t)),t.NMHConnStatus=this.NMHConnStatus,t.is_edge=e.isEdge(),chrome.runtime.sendMessage(t)}filenameFromUrl(e){try{const t=decodeURIComponent(e),s=t.split("?")[0].split("/").filter((e=>e.length>0)),i=s.length>0?s[s.length-1]:"untitled";let a=i;const n=i.length-4;return(i.length<4|