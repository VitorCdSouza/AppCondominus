ull!=e.tabId&&(this.tabs[e.tabId].persist=!0):e.persist=!1,this.resetPersistPrefCount()}this.sendMessage(e)}sendViewerStartupInformation(t,i,r){if(this.isViewerEnabled()&&e.isViewerURL(i)||t.mimeHandled){if("viewer-startup"===t.main_op&&(delete t.main_op,t.isFrictionlessEnabled=l.FRICTIONLESS_ENABLED,t.isSharePointEnabled=n.isFeatureEnabled(),t.isSharePointURL=!1),t.isSharePointEnabled)try{let e=new URL(i).searchParams.get("pdfurl");t.isSharePointURL=n.isAllowListedSharePointURL(e)}catch(e){}if(t.mimeHandled)if(s.event(s.e.VIEWER_EXTN_PDF_OPENED),i.startsWith("file://"))s.event(s.e.VIEWER_PDF_LOCAL_FILE);else{const{origin:e}=new URL(i);s.setArg("pdfDomain",e),s.event(s.e.VIEWER_PDF_OPENED_MIME_HANDLER),s.setArg("pdfDomain",null)}t.isFillnSignEnabled=l.FILL_N_SIGN_ENABLED,a.getFeaturesAndGroups().then((({featureFlags:e})=>{t.featureFlags=e,r(t)})).catch((s=>{r(t),e.consoleLog(s)}))}}async sendViewerPreviewInformation(e,t){this.sendMessage({dend_op:"viewer-type",viewer:"mime",tabId:e.tabId,is_pdf:!0}),await o.updateVariables(this.version),t()}handlerTabs(e){r.isMimeHandlerAvailable().then((t=>{if(t&&e&&e.tabId&&"outermost_frame"===e.frameType){const t=d.getItem("loadedTabsInfo");if(t&&t.tabsInfo){const s=t.tabsInfo;if(s.includes(e.tabId)){const t=s.filter((t=>t!==e.tabId));t.length>0?d.setItem("loadedTabsInfo",{tabsInfo:t}):d.removeItem("loadedTabsInfo")}}}}))}handler(t,i,n){var o,l=this;if(!t)return;if(this.dump(t,"Communicate Handler receive: "),t.mimeHandled){var c={id:t.tabId,url:t.url};i.tab=c}const p=`chrome-extension://${chrome.runtime.id}/browser/js/popup.html`;if(i.url===p&&(i.tab=t.tab,delete t.tab),i&&i.tab&&(t.tabId=i.tab.id,this.activeTab||(this.activeTab=i.tab.id),t.main_op)){switch(o=t.main_op,delete t.main_op,s.logBrowserAnalytics(t),this.tabs[t.tabId]&&this.tabs[t.tabId].suppress_frictionless&&(t.suppress_frictionless=this.tabs[t.tabId].suppress_frictionless),t.version=this.version,t.NMHConnStatus=this.NMHConnStatus,o){case"viewer-preview":return this.sendViewerPreviewInformation(t,n),!0;case"get-features&groups":return a.getFeaturesAndGroups(t.cachePurge).then((e=>n(e))),!0;case"getFloodgateFlag":a.hasFlag(t.flag).then(n);break;case"openRecentFileLink":e.createTab(t.recent_file_url);break;case"viewer-type":setTimeout((()=>{this.sendMessage({dend_op:"viewer-type",viewer:t.viewer,tabId:t.tabId,is_pdf:!0})}),500);case"init-floodgate":setTimeout((()=>a.init()),2e3);break;case"complete_conversion":e.createTab(t.conversion_url);break;case"analytics":break;case"relay_to_content":this.relayMessageToContentScript(t);break;case"viewer-startup":t.main_op="viewer-startup",this.sendViewerStartupInformation(t,i.tab.url,n);break;case"check-cookie":n(d.getItem(t.key));break;case"set-cookie":d.setItem(t.key,t.value);break;case"check-mime-viewer-availability":r.isMimeHandlerAvailable().then((e=>{e?"false"===d.getItem("pdfViewer")||"true"===d.getItem("cdnFailure")?this.sendMessage({dend_op:"viewer-type",tabId:i.tab.id,viewer:"mime-native",is_pdf:!0}):t.url&&t.url.startsWith("file://")&&(this.isAllowedLocalFileAccess||(s.event(s.e.VIEWER_PDF_LOCAL_FILE_IGNORED),l.sendMessage({dend_op:"viewer-type",tabId:i.tab.id,viewer:"mime-native",is_pdf:!0}))):this.sendMessage({dend_op:"viewer-type",tabId:i.tab.id,viewer:"native",is_pdf:!0})}));break;case"uninstall":r.setViewerState("disabled"),d.setItem("pdfViewer","false"),d.setItem("always-show-pdf-menu","false"),e.mimeReloadAllTabs(),d.removeItem("userEligibleForUninstall"),chrome.runtime.setUninstallURL(""),s.event(s.e.UNINSTALL_DIALOG_UNINSTALLED_SUCCESSFUL),setTimeout((()=>{chrome.management.uninstallSelf()}),1e3);break;case"caret_mode_toggle_handler":chrome.runtime.sendMessage({main_op:"relay_to_content",content_op:"caret_mode_toggle_handler",status:t